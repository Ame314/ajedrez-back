<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tester WebSocket Ajedrez</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        button {
            margin: 5px;
            padding: 8px 15px;
        }

        input,
        textarea {
            margin: 5px;
            padding: 5px;
            width: 300px;
        }

        #messages {
            height: 300px;
            overflow-y: scroll;
            border: 1px solid #ccc;
            padding: 10px;
            background: #f9f9f9;
        }

        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }

        .sent {
            background: #e3f2fd;
        }

        .received {
            background: #f1f8e9;
        }

        .error {
            background: #ffebee;
            color: red;
        }

        .status {
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🧪 Tester WebSocket Ajedrez</h1>

        <div class="section">
            <h3>1. Obtener Token</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button onclick="login()">Login y Obtener Token</button>
            <div id="tokenDisplay"></div>
        </div>

        <div class="section">
            <h3>2. Conexión WebSocket</h3>
            <button onclick="connectWS()">Conectar WebSocket</button>
            <button onclick="disconnectWS()">Desconectar</button>
            <div id="connectionStatus" class="status">Desconectado</div>
        </div>

        <div class="section">
            <h3>3. Mensajes</h3>
            <div id="messages"></div>
        </div>

        <div class="section">
            <h3>4. Pruebas Rápidas</h3>
            <button onclick="sendPing()">Ping</button>
            <button onclick="findMatch()">Buscar Partida</button>
            <button onclick="cancelMatch()">Cancelar Búsqueda</button>
            <button onclick="sendTestMove()">Movimiento de Prueba</button>
        </div>

        <div class="section">
            <h3>5. Mensaje Personalizado</h3>
            <textarea id="customMessage" placeholder='{"type": "ping"}'></textarea><br>
            <button onclick="sendCustomMessage()">Enviar</button>
        </div>
    </div>

    <script>
        let ws = null;
        let token = null;
        let currentGameId = null;

        function addMessage(content, type = 'info') {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${content}`;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!email || !password) {
                addMessage('Email y password requeridos', 'error');
                return;
            }

            try {
                const response = await fetch('http://localhost:8000/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    token = data.access_token;
                    document.getElementById('tokenDisplay').innerHTML =
                        `<strong>Token obtenido:</strong> ${token.substring(0, 50)}...`;
                    addMessage('✅ Login exitoso', 'received');
                } else {
                    addMessage('❌ Error en login: ' + await response.text(), 'error');
                }
            } catch (error) {
                addMessage('❌ Error de conexión: ' + error, 'error');
            }
        }

        function connectWS() {
            if (!token) {
                addMessage('❌ Primero obtén un token con login', 'error');
                return;
            }

            try {
                ws = new WebSocket(`ws://localhost:8000/ws/${token}`);

                ws.onopen = () => {
                    document.getElementById('connectionStatus').textContent = 'Conectado ✅';
                    addMessage('🔌 WebSocket conectado', 'received');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    addMessage(`📥 ${JSON.stringify(data, null, 2)}`, 'received');

                    // Guardar game_id si se inicia una partida
                    if (data.type === 'game_start') {
                        currentGameId = data.game_id;
                        addMessage(`🎮 Partida iniciada: ${currentGameId}`, 'received');
                    }
                };

                ws.onclose = () => {
                    document.getElementById('connectionStatus').textContent = 'Desconectado ❌';
                    addMessage('🔌 WebSocket desconectado', 'error');
                };

                ws.onerror = (error) => {
                    addMessage('❌ Error WebSocket: ' + error, 'error');
                };

            } catch (error) {
                addMessage('❌ Error conectando: ' + error, 'error');
            }
        }

        function disconnectWS() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage(message) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addMessage('❌ WebSocket no conectado', 'error');
                return;
            }

            ws.send(JSON.stringify(message));
            addMessage(`📤 ${JSON.stringify(message, null, 2)}`, 'sent');
        }

        function sendPing() {
            sendMessage({ type: 'ping' });
        }

        function findMatch() {
            sendMessage({ type: 'find_match', elo: 1200 });
        }

        function cancelMatch() {
            sendMessage({ type: 'cancel_match' });
        }

        function sendTestMove() {
            if (!currentGameId) {
                addMessage('❌ No hay partida activa', 'error');
                return;
            }

            sendMessage({
                type: 'move',
                game_id: currentGameId,
                move: {
                    from_square: 'e2',
                    to_square: 'e4',
                    piece: 'P',
                    san: 'e4',
                    fen: 'rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1'
                }
            });
        }

        function sendCustomMessage() {
            const messageText = document.getElementById('customMessage').value;
            if (!messageText) return;

            try {
                const message = JSON.parse(messageText);
                sendMessage(message);
            } catch (error) {
                addMessage('❌ JSON inválido: ' + error, 'error');
            }
        }

        // Limpiar al cerrar
        window.addEventListener('beforeunload', () => {
            if (ws) ws.close();
        });
    </script>
</body>

</html>